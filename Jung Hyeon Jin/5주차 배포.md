CodePipeline을 구축하기 위한 yml 파일 수정본
```
version: 0.1

phases:
  pre_build:
    commands:
      - echo "=== PRE_BUILD ==="
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com

  build:
    commands:
      - echo "=== BUILD ==="
      - docker build -t $IMAGE_REPO_NAME:$IMAGE_TAG .
      - docker tag $IMAGE_REPO_NAME:$IMAGE_TAG $ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG

  post_build:
    commands:
      - echo "=== POST_BUILD push image ==="
      - docker push $ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME:$IMAGE_TAG

      - echo "=== Create imagedefinitions.json ==="
      - |
        cat <<EOF > imageDetail.json
        {
          "name": "Bwapp-container",
          "image": "$ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/ljh_1:$IMAGE_TAG"
        }
        EOF

      - echo "=== Create taskdef.json ==="
      - |
        cat <<EOF > taskdef.api.json
        {
          "family": "SCT-Bwapp-defition",
          "executionRoleArn": "arn:aws:iam::$ACCOUNT_ID:role/ecsTaskExecutionRole",
          "networkMode": "awsvpc",
          "requiresCompatibilities": ["FARGATE"],
          "cpu": "256",
          "memory": "2048",
          "containerDefinitions": [
            {
              "name": "Bwapp-container",
              "image": "$ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/ljh_1:$IMAGE_TAG",
              "essential": true,
              "portMappings": [
                {
                  "containerPort": 7890,
                  "protocol": "tcp"
                }
              ]
            }
          ]
        }
        EOF

      - echo "=== Create appspec.api.yml ==="
      - |
        cat <<EOF > appspec.api.yml
        version: 0.0
        Resources:
          - TargetService:
              Type: AWS::ECS::Service
              Properties:
                TaskDefinition: "SCT-Bwapp-task-defition"
                LoadBalancerInfo:
                  ContainerName: "Bwapp-container"
                  ContainerPort: 7890
        EOF

artifacts:
  files:
    - imageDetail.json
    - taskdef.api.json
    - appspec.api.yml
```

### 해결 과정
<img width="2000" height="1125" alt="image" src="https://github.com/user-attachments/assets/cbd4883e-b17a-4d93-9b64-dc6971ebd783" />
<img width="2066" height="1163" alt="image" src="https://github.com/user-attachments/assets/e65fdf65-9123-4726-986f-fdbc57b6a2a9" />

Json을 통해 아래 코드를 입력한다.
```
{
    "Version": "2012-10-17",
    "Statement": [
        {   
            "Effect": "Allow",
            "Resource": [
                "arn:aws:logs:ap-northeast-2:[계정 번호]:log-group:/aws/codebuild/bWAPP-CodeBuild",
                "arn:aws:logs:ap-northeast-2:[계정 번호]:log-group:/aws/codebuild/bWAPP-CodeBuild:*"
            ],
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "codebuild:CreateReportGroup",
                "codebuild:CreateReport",
                "codebuild:UpdateReport",
                "codebuild:BatchPutTestCases",
                "codebuild:BatchPutCodeCoverages"
            ],
            "Resource": [
                "arn:aws:codebuild:ap-northeast-2:[계정 번호]:report-group/bWAPP-CodeBuild-*"
            ]
        }
    ]
}
```
<img width="2097" height="1045" alt="image" src="https://github.com/user-attachments/assets/3de7854f-f4e3-4805-8c00-1b4b0967be95" />



## 첫 번째 오류 - CodeBuild 생성 도중 생긴 오류
- CodeBuild에서 사용 중인 **IAM 역할**에 GitHub 연결을 사용할 권한이 없다.
- **연결 하기 위해서는 CodeBuild 서비스 역할에** `codebuild:UseConnection` 권한이 포함되어야 한다.

### 해결 과정
<img width="2062" height="1220" alt="image" src="https://github.com/user-attachments/assets/f25fe5de-0069-40fd-8316-fdaad0f2f2d4" />
<img width="2066" height="1163" alt="image" src="https://github.com/user-attachments/assets/e75625cf-28ee-44c9-8238-79fc73275200" />
Json을 통해 아래 코드를 입력한다.
```
{
    "Version": "2012-10-17",
    "Statement": [
        {   
            "Effect": "Allow",
            "Resource": [
                "arn:aws:logs:ap-northeast-2:329984431650:log-group:/aws/codebuild/bWAPP-CodeBuild",
                "arn:aws:logs:ap-northeast-2:329984431650:log-group:/aws/codebuild/bWAPP-CodeBuild:*"
            ],
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "codebuild:CreateReportGroup",
                "codebuild:CreateReport",
                "codebuild:UpdateReport",
                "codebuild:BatchPutTestCases",
                "codebuild:BatchPutCodeCoverages"
            ],
            "Resource": [
                "arn:aws:codebuild:ap-northeast-2:329984431650:report-group/bWAPP-CodeBuild-*"
            ]
        }
    ]
}
```
<img width="2097" height="1045" alt="image" src="https://github.com/user-attachments/assets/9ec76b7f-0b4f-4101-a80a-31d589f21309" />

- 생성한 정책을 연결하기 위한 역할 생성
<img width="2000" height="1093" alt="image" src="https://github.com/user-attachments/assets/2be5ba05-f150-482b-9c82-a7eb2aff843f" />
<img width="2000" height="1096" alt="image" src="https://github.com/user-attachments/assets/80b7e5fb-17a5-4042-8c7a-d73ad1776ca0" />
<img width="2000" height="506" alt="image" src="https://github.com/user-attachments/assets/ddb027ac-82cb-4d78-b088-23790bfce407" />
<img width="2000" height="1161" alt="image" src="https://github.com/user-attachments/assets/9aa87744-2b5c-4f3d-a63b-85ba19fdc7aa" />


## 두 번째 오류 - 빌드 실패(1)
**CodeBuild가 ECR에 로그인하려고 하는데 권한이 없어서 실패**
→ 도커 로그인이 안됨
**bWAPP-CodeBuild-service-Role에 ECR 접근 권한이 존재하지 않기 때문**
- ECR에 접근 가능해야 도커 이미지 푸시 가능

### 해결 과정
아까 전 만들어둔 정책에 아래 코드를 추가한다.
```
{
            "Effect": "Allow",
            "Action": [
                "ecr:GetAuthorizationToken",
                "ecr:BatchCheckLayerAvailability",
                "ecr:PutImage",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:CompleteLayerUpload"
            ],
            "Resource": "*"
        }
```

## 세 번째 오류 - 빌드 실패 (2)
CodeBuild 서비스 역할에 Secrets Manager 접근 권한이 없어서 발생

### Secrets Manager
- AWS에서 제공하는 보안 자격 증명 및 비밀 관리 서비스
민감한 정보를 안전하게 저장 및 관리할 수 있도록 해준다.

### 해결 과정
CodeBuild 역할에 다음과 같은 권한을 추가하였다.
```
{
    "Effect": "Allow",
    "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
    ],
    "Resource": "arn:aws:secretsmanager:ap-northeast-2:329984431650:secret:JHJ-2-ouLYGG"
}
```





## task 설정
<img width="2055" height="1138" alt="image" src="https://github.com/user-attachments/assets/30c19d17-9fbe-4469-bfa0-1d7e6f8288c6" />
<img width="2055" height="1138" alt="image" src="https://github.com/user-attachments/assets/5c623aae-fefc-4c24-8a53-4b2a6368194d" />
이 외 설정은 기본으로 했습니다.

## 클러스터 서비스 생성
<img width="2062" height="1140" alt="image" src="https://github.com/user-attachments/assets/e00753d0-305b-40aa-8edd-9f92713c030e" />
<img width="2045" height="1122" alt="image" src="https://github.com/user-attachments/assets/fb15f031-1176-46b7-be9b-59622e793805" />
<img width="2068" height="1135" alt="image" src="https://github.com/user-attachments/assets/78512ced-0011-4793-a76b-03f736ecda51" />
<img width="2068" height="1135" alt="image" src="https://github.com/user-attachments/assets/9c5aa8ca-ad27-4827-9f76-8118a4972522" />
<img width="2048" height="1139" alt="image" src="https://github.com/user-attachments/assets/937ae302-a595-4e53-ac88-7833fd3cf237" />
<img width="2051" height="1205" alt="image" src="https://github.com/user-attachments/assets/fda45630-1932-4678-867c-bf4327829da8" />
`나머지 설정은 기본으로 셋팅 했습니다.`

ECS 서비스에서 배포 컨트롤러를 CodeDeploy로 설정하기 위해서는 AWS CLI를 사용해야 한다.

IAM 역할 생성(cluster service 생성하기 위해 사용)
<img width="2061" height="1177" alt="image" src="https://github.com/user-attachments/assets/af462bbb-62a8-469e-a288-d6e0fdbaaf45" />
<img width="2083" height="690" alt="image" src="https://github.com/user-attachments/assets/5f883e43-01ae-4af8-bf27-1fcc3358182b" />
<img width="2059" height="1144" alt="image" src="https://github.com/user-attachments/assets/1af2ec0d-5a0c-447c-8881-c26bce0e2cb2" />

## 1차 테스크 배포
```
Task failed ELB health checks in (target-group arn:aws:elasticloadbalancing:ap-northeast-2:[계정 번호]:targetgroup/Bwapp-Green-tg/9f401d8c662cd0ce)
```
위와 같은 오류가 나면서 실패
- ALB 헬스 체크에 실패해서 비정상으로 판단하여 종료
AWS CLI로 health check 문제점을 찾을 수 있는 명령어를 찾게 되었습니다.
<img width="2318" height="354" alt="image" src="https://github.com/user-attachments/assets/bdfb6c58-7341-448c-9b7c-99a5fe16ab5a" />
Target.DeregistrationInProgress - 대상이 등록 취소 중이며 등록 취소 지연 기간이 만
료되지 않았습니다.
Target.FailedHealthChecks - 로드 밸런서가 대상에 대한 연결을 설정하는 동안 오류를 수
신했거나 대상 응답의 형식이 잘못되었습니다.

# 실패 주된 원인

```yaml
 netstat -lnt
```
위의 명령어를 입력하면 네트워크 연결 상태, 라우팅 테이블, 인터페이스 상태 등을 확인할 수 있다.
이를 통해 8080에서 신호를 기다리는 컨테이너가 존재하지 않다는 것을 알게되었다.
어쩌면 Docker file 문제일 것이라고 생각하여 확인해보았다.

1. 도커 파일에서 80 포트로 EXPOSE
→ 수정 후 Health checks failed with these codes: 302 오류 발생
2. 경로 문제라고 하여 health check 경로를 /health 로 변경
→ 수정 후 Health checks failed with these codes: [404] 오류 발생 
이번에는 기본 경로가 아니라고 나오며 / 로 변경할 것을 권장
사실 위와 같은 오류가 발생하면 성공 코드를 그에 맞춰 추가하면 된다.
<img width="1771" height="980" alt="image" src="https://github.com/user-attachments/assets/6e658b06-fcd2-4886-98dc-8d1a2d704002" />
<img width="2518" height="418" alt="image" src="https://github.com/user-attachments/assets/c048b0ea-c9f5-4a39-bf29-2877efc9ef69" />
<img width="2539" height="414" alt="image" src="https://github.com/user-attachments/assets/1d79aceb-a427-460e-ae0e-99b01af29127" />
404 코드를 보내지 않도록 하기 위해서는 health check를 해주는 API를 제작해야 한다고 하지만 방법을 찾지 못했다.

### 타겟 그룹 배포 포트 설정
- 블루그린 배포 환경에서도 어차피 내부 ip만 다르면 되서 포트가 같아도 문제가 없는 것을 확인
  이에 그린 환경의 포트인 8081을 8080으로 변경
- 이후 ECS로 설정되어 있는 배포 컨트롤러 유형을 CodeDeploy로 변경하기 위해 아래와 같은 명령어 입력

```yaml
aws ecs create-service 
--cluster Bwapp-cluster 
--service-name Bwapp-service 
--task-definition Bwapp-tasks 
--desired-count 1 
--launch-type FARGATE 
--deployment-controller type=CODE_DEPLOY 
--network-configuration "awsvpcConfiguration={subnets=[subnet-0e161b7d3de7b2669,subnet-0aa618d7a12374c4d],securityGroups=[sg-061d620a5933b6780],assignPublicIp=DISABLED}" 
--load-balancers "[{\"targetGroupArn\":\"arn:aws:elasticloadbalancing:ap-northeast-2:329984431650:targetgroup/Bwapp-Blue-tg/83e84ce255542f3a\",\"containerName\":\"Bwapp-container\",\"containerPort\":8080}]"
```

## 성공했지만 실패한 것 같아보이는 배포 모습
<img width="2355" height="1139" alt="image" src="https://github.com/user-attachments/assets/66ef2c3d-445f-4ed4-9bd3-b7410ae004cd" />

<img width="1608" height="436" alt="image" src="https://github.com/user-attachments/assets/c649865c-0aae-4a46-b2bd-09def665c639" />
