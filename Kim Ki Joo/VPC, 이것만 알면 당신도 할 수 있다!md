# 2025-11-10 자료조사 : VPC, 이것만 알면 당신도 할 수 있다!



> **목표 : 이것을 읽고 당신이 우리의 VPC 구조를 이해해주지 못한다면, 이것은 매우 슬픈이야기이다.
그렇기에, 이것을 여러번 정독하면서 당신이 VPC의 구조를 읽을 수 있게 되길.
아래에서는 VPC의 서비스와 기본개념 + 네트워크에 대해서 배워보자.**
> 

### 목차

1. **꼭 읽어봤음 좋을 기초지식들 (네트워크 기본 지식 + 리전, AZ 등.. )**
2. **VPC란?**
3. **서브넷이란?**
4. **라우팅/ 라우팅 테이블이란?**
5. **IGW(인터넷 게이트웨이)란?**
6. **NAT Gateway란?**
7. **Bastion Host란?**
8. **보안그룹 (Security Group) 이란?**
9. **NACL (Network Access Control List)란?**
10. **엔드포인트 (End Point)란?**

- **꼭~ 읽어봤음 좋을 기초지식들 (다른 사람 Tistory로 대체)**
    
    *정말 제발 필독 하시길 바라고 있어요.*
    
    https://inpa.tistory.com/entry/WEB-IP-%ED%81%B4%EB%9E%98%EC%8A%A4-%EC%84%9C%EB%B8%8C%EB%84%B7-%EB%A7%88%EC%8A%A4%ED%81%AC-%EC%84%9C%EB%B8%8C%EB%84%B7%ED%8C%85-%EC%B4%9D%EC%A0%95%EB%A6%AC
    
    - 네트워크의 첫번째와 마지막 IP는 사용이 불가능하다. (네트워크 주소와 브로드 캐스트 주소)
    
    https://inpa.tistory.com/entry/WEB-%F0%9F%8C%90-CIDR-%EC%9D%B4-%EB%AC%B4%EC%96%BC-%EB%A7%90%ED%95%98%EB%8A%94%EA%B1%B0%EC%95%BC-%E2%87%9B-%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC-%EA%B3%84%EC%82%B0%EB%B2%95
    
    - AWS CIDR 은 5개를 제외해줘야한다.
    10.0.0.0 → 네트워크 주소
    10.0.0.1 → AWS에서 VPC 라우터용으로 예약(기본값 GateWay)
    10.0.0.2 → DNS 서버 주소 (기본 VPC 네트워크 범위 +2)
    10.0.0.3 → AWS에서 앞으로 사용하려고 예약한 주소
    10.0.0.255 → 네트워크 브로드캐스트 주소
    
    https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-%EC%95%84%EB%A7%88%EC%A1%B4-%EC%9B%B9-%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B5%AC%EC%A1%B0-Region-AZ-Edge-Location-Cache-%EC%99%84%EB%B2%BD-%EC%A0%95%EB%A6%AC
    
    https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-%EC%9E%90%EC%A3%BC-%EC%93%B0%EC%9D%B4%EB%8A%94-aws-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9-%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C-%EC%9A%A9%EC%96%B4-%EC%A0%95%EB%A6%AC
    
- **VPC란?**
    - 사용자가 정의하는 aws 계정 사용자 전용 외부와 격리된 가상의 네트워크
    - 자신이 원하는대로 IP 주소 범위 선택, 서브넷 생성, 라우팅 테이블 및 네트워크 게이트웨이 구성 등
    가상 네트워크 환경을 구성할 수 있음.
- **서브넷(Subnet)이란?**
    - VPC의 IP 주소를 나누어 리소스가 배치되는 물리적인 주소 범위
    - VPC가 논리적인 부분이라면, 서브넷은 실제로 리소스가 생성될 수 있는 네트워크 영역임
    - 하나의 VPC안에 N개의 서브넷을 가질 수 있으며 하나의 AZ에만 생성이 가능하다.
    EX) AZ-a 와 AZ-c를 걸치는 서브넷을 생성 못함
    EX) 하나의 AZ에 여러 개의 Subnet 생성 가능
    - Private Subnet / Public Subnet:
    Private : 인터넷에 접근이 `불가능한` 서브넷 (VPC 내부에서만 통신)
    Public : 인터넷에 접근이 `가능한` 서브넷 (VPC 외부 / 내부와 통신)
    
- **라우팅/라우팅 테이블(RTB)이란?**
    - Routing: 네트워크에서 통신 데이터를 목적지까지 보내기 위해 최적의 경로를 선택하는 과정
    (AWS식 해석: 한 서브넷이 다른 서브넷으로 가기위해서 필요한 과정)
    - Routing Table: VPC안에서 발생한 네트워크 요청을 처리하기 위해 어디로 트래픽을 전송해야하는 전달 규칙 저장소
- **Internet Gateway(IGW)란?**
    - VPC의 인스턴스와 인터넷간에 통신을 할 수 있게 VPC에 연결하는 관문
    (VPC 리소스가 인터넷으로 나가기 위한 통로)
    - VPC는 기본적으로 격리된 네트워크 환경이다보니, 리소스들은 기본적으로 인터넷을 사용할 수 없음
    
- **NAT Gateway란?**
    - NAT(Network Address Traslation):  IP 패킷의 TCP/UDP 포트 숫자와 소스 및 목적지의 
    IP 주소 등을 재기록하면서 라우터를 통해 네트워크 트래픽을 주고 받는 기술.
    (대표적으로는 여러개의 사설 호스트들이 하나의 공인 IP 주소를 사용해 
    외부 인터넷과 통신하기 위해서 사용함.)
    - NAT 게이트웨이는 프라이빗 서브넷이 외부 인터넷으로 나갈 경우에 사용하도록 라우팅을 추가해주는 것
    (그러므로, NAT 게이트웨이의 위치는 퍼블릭 서브넷에 있어야합니다!)
    - NAT 게이트웨이는 내부에서 외로의 접속만 가능하며, 
    외부에서 NAT 게이트웨이를 이용하여 접속하는 것은 불가능!
    - NAT 게이트웨이 대용으로 NAT 인스턴스를 돌릴 수 있다. (비용적인 측면에서는 훨씬 훌륭함)
    관련 주소 : https://inpa.tistory.com/entry/AWS-%F0%9F%93%9A-NAT-Gateway-NAT-Instance-%EB%8C%80%EC%B2%B4%ED%95%B4%EC%84%9C-%EB%B9%84%EC%9A%A9-%EC%A0%88%EC%95%BD
    
- **Bastion Host란?**
    - 내부와 외부 네트워크 사이에서 일종의 게이트 역할을 수행하는 호스트
    (AWS에서는 SSH로 외부에서 프라이빗 서브넷에 접속할 수 있게 해주는 역할을 함)
    - NAT 게이트웨이처럼 서비스를 만들어서 등록하는게 아니라,
    프라이빗 서브넷에 연결되어 접속할 수 있는 퍼블릭 서브넷을 Bastion Host라고 말함.
    
- **보안그룹(Security Group, SG)이란?**
    - VPC내 모든 인스턴스에 대한 인바운드 & 아웃바운드 트래픽을 제어하는 가상 방화벽 역할을 함.
    - 가장 큰 특징으로는 Stateful이다.
    **상태를 저장하여** 한 번 인/아웃바운드를 통과하는 트래픽은 인/아웃 바운드 규칙 적용을 받지 않는다.
    - 그 외에 특징들
        - 허용 규칙만 생성 가능
        - 기본적으로 모든 보안 그룹의 아웃바운드 규칙은 모든 아웃바운드 트래픽을 허용한다.
        - 보안 그룹은 인스턴스 단위로 설정한다.
        하나에 인스턴스에는 최소 1개 이상에서 최대 5개까지 동시 적용이 가능하다.
        - 각 인스턴스에 각각 서로 다른 보안 그룹에도 할당이 가능하다.
        - 설정된 인스턴스는 연결되어있는 보안그룹의 모든 룰에 적용 받는다.
- **NACL (Network Access Control List)란?**
    - Subnet의 Access List(접근 제어 목록)을 담당하고 있다.
    - 보안그룹이 인스턴스 접근 제어 목록이라면, NACL은 서브넷의 모든 트래픽을 제어한다.
    - NACL은 Subnet 단위로 적용되기 때문에 Subnet 내의 모든 트래픽은 NACL의 규칙을 적용받는다.
    EX) NACL에서 80번 포트를 허용하지 않으면, 보안그룹이 허용한다고해도 들어올 수 없음.
    - NACL은 Stateless로
    **인바운드 규칙을 적용받아 유입된 패킷**이 다시 밖으로 나가기위해서는 **아웃바운드 규칙의 적용을 받고**,
    **아웃바운드 규칙을 적용받아 나가는 패킷**이 다시 안으로 들어오기위해서는 **인바운드 규칙의 적용을 받음**.
    
- ***엔드포인트란?***
    
    *해당 내용에서는 VPC 엔드포인트에 대해서 설명합니다. 이외의 것들은 검색해보시길..*
    
    - VPC 내 리소스들이 VPC 외부의 서비스(S3, Dynamo DB, Cloudwatch) 등에 접근할때,
    IGW, NAT 게이트웨이 등의 외부 인터넷 전송 서비스를 타지 않고, 
    내부 네트워크를 통해 접근할 수 있도록 지원하는 서비스이다.
    - AWS VPC는 사설 네트워크로 이루어져있기에, VPC 내 EC2, RDS, ELB 등을 탑재하고
    ENI(Elastic Network Interface)에 사설 IP 혹인 공인 IP를 부여하여 사용한다.
    - 다른 AWS 서비스들은 VPC 외부에 있기에 공인 IP 가지고 외부에서 접근해야하는 서비스들임.
    - VPC Endpoint는 **AWS 여러 서비스들과 VPC를 연결시켜주는 중간 매개체**로서,
    AWS에서 VPC 바깥으로 트래픽이 나가지 않고 
    AWS의 여러 서비스들을 사용할 수 있게 만들어주는 서비스.

### 그렇다면 우리의 VPC 설정은 어떻게 되어있나요?

- VPC
    
    - VPC 마법사를 통해서 설정,
    - 이름 : Bwapp-sct
    - IPv4 CIDR 블록 : 10.0.0.0/16 (AWS VPC 국룰 설정이라고 함)
    - IPv6 CIDR 블록 : 생성안함(우리가 사용하는거는 오로지 IPv4)
    - 가용 영역(AZ) : 2개 (블루 지역, 그린 지역 하나씩)
    - 가용영역 설정 :
    첫번째 가용영역 : ap-northeast-2a 
    두번째 가용영역 : ap-northeast-2c
        - 왜 -a, -c로 해야하죠? :
            - [-a, -b], [-c, -d]로 각각 하나의 그룹으로 뭉쳐있는데,
            -a, -c만 있던 서울 리전에서 -b와 -d가 비교적 최근에 생성됨.
            즉, 더 예전에 있었던 안정적인 버전인 -a, -c를 사용함.
            - 그리고 -a,-b나 -c,-d로 조합하지 않는 이유는 같은 그룹 안에 한쪽 가용영역에 문제가 생기면 다른 가용구역에도 같이 장애가 발생 할 수 있기 떄문.
    
    - 퍼블릭 서브넷 수 2개 (AZ 당 1개씩)
    - 프라이빗 서브넷 수 2개 (각 AZ당 1개씩)
    - NAT 게이트웨이 : AZ당 1개씩 (한개의 AZ로 하면, 하나의 프라이빗 서브넷은 사용할 수 없음)
    - VPC 엔드포인트 : 없음 ( 아키텍처 내의 S3 사용이 없음.)
- 보안 그룹(SG)

    - 보안 그룹 이름: Bwapp-ALB-sg
    - 인바운드 규칙 : HTTP(80) IPv4-Anywhere
    - 아웃바운드 규칙: 모든 트래픽 / IPv4-Anywhere
    
    - 보안 그룹: Bwapp-ECS-sg
    - 인바운드 규칙: TCP 80(HTTP) 접속 모든 아이피 허용
    - 아웃바운드 규칙: 모든 트래픽 아웃바운드 허용
    
    - ALB-sg 아웃바운드 규칙 변경
    ECS-sg의 모든 트래픽을 아웃바운드 허용.

    - ECS-sg 인바운드 규칙 변경
    ALB-sg로 TCP ~~7890~~ → 8080포트로 들어오는 트래픽 인바운드 허용
- 대상 그룹(TG)
  
    
    - 대상 유형 : IP 주소
    - 이름 : Bwapp-Blue-tg
    - 프로토콜 : HTTP:~~7890~~ → :8080
    - IP 주소 유형 : IPv4
  
    
    - VPC: Bwapp-sct-vpc
    - 프로토콜 버전: HTTP1
    - 상태검사 : HTTP  경로: /
    
    
    - 대상 등록 : 그대로 두고 진행
    
    (이외에 그린도 같은 과정으로 만들어줍니다.)

    
- 로드 벨런서(ABL)
    
    - IGW로 들어오는 신호를 처리해야하니 인터넷 경계로 설정
    - IP 주소 유형 : IPv4
    
    - 네트워크 매핑에서는
    - VPC : Bwapp-sct-vpc
    - 가용 영역 및 서브넷:
    ap-northeast-2a : 퍼블릭 서브넷 선택
    ap-northeast-2c :  퍼블릭 서브넷 선택
    - 퍼블릭 서브넷으로 해야하는 이유? : 인터넷 신호를 받고 처리하기 위해서는
    
    - 리스너 설정
    - 프로토콜:포트  :  HTTP(80)
    - 기본 작업 : 대상 그룹으로 전달
    대상 그룹 : Bwapp-Blue-tg ( 100% )
    대상 그룹 : Bwapp-Green-tg ( 100% )
